<html lang="en">
<head>
<meta charset="UTF-8">
<title>UID Raffle</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui;
  padding:20px;
}
.container {
  max-width:900px;
  margin:auto;
  border:1px solid #1f2937;
  border-radius:12px;
  padding:20px;
}
h1,h2 {
  margin:0 0 12px 0;
}
input, button {
  background:#020617;
  color:#e5e7eb;
  border:1px solid #374151;
  border-radius:8px;
  padding:8px;
}
button {
  cursor:pointer;
}
button.primary {
  background:#38bdf8;
  color:#020617;
  font-weight:600;
}
.row {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
}
th,td {
  border-bottom:1px solid #1f2937;
  padding:6px;
  font-size:13px;
}
th {
  color:#9ca3af;
  text-align:left;
}
.highlight {
  color:#22c55e;
  font-weight:700;
}
.small {
  font-size:12px;
  color:#9ca3af;
}
.reset {
  background:#7f1d1d;
  color:#fff;
}
</style>
</head>
<body>

<div class="container">
<h1>UID Raffle</h1>

<div class="row">
  <input id="uidInput" placeholder="UID">
  <input id="entryInput" type="number" min="1" value="1">
  <button class="primary" onclick="addOrUpdate()">Add / Update</button>
</div>

<div class="row">
  <input id="prizeInput" placeholder="Prize (e.g. Echo Beads ×60)">
  <button class="primary" onclick="draw()">Draw Winner</button>
  <button class="reset" onclick="resetAll()">Reset All</button>
</div>

<h2>Entries</h2>
<table>
<thead>
<tr><th>UID</th><th>Entries</th></tr>
</thead>
<tbody id="entryTable"></tbody>
</table>

<h2 style="margin-top:20px;">Leaderboard</h2>
<table>
<thead>
<tr>
  <th>UID</th>
  <th>Echo Beads ×60 Wins</th>
  <th>Monthly Fund Wins</th>
</tr>
</thead>
<tbody id="leaderboard"></tbody>
</table>

<div id="result" class="highlight" style="margin-top:12px;"></div>
<div class="small" id="details"></div>

</div>

<script>
const STORAGE_KEY = "uid_raffle_state";

const entries = {};
const wins = {};

function saveState() {
  localStorage.setItem(
    STORAGE_KEY,
    JSON.stringify({ entries, wins })
  );
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    Object.assign(entries, data.entries || {});
    Object.assign(wins, data.wins || {});
  } catch {}
}

function addOrUpdate() {
  const uid = uidInput.value.trim();
  const count = parseInt(entryInput.value,10);
  if (!uid || count <= 0) return;

  entries[uid] = (entries[uid] || 0) + count;
  wins[uid] ??= { beads:0, monthly:0 };

  saveState();
  renderEntries();
  renderLeaderboard();
}

function draw() {
  const prize = prizeInput.value.trim();
  if (!prize) return;

  const total = Object.values(entries).reduce((a,b)=>a+b,0);
  if (total <= 0) return;

  const roll = crypto.getRandomValues(new Uint32Array(1))[0] % total;
  let acc = 0, winner = null;

  for (const uid in entries) {
    acc += entries[uid];
    if (roll < acc) {
      winner = uid;
      break;
    }
  }

  if (!winner) return;

  if (prize.toLowerCase().includes("60")) wins[winner].beads++;
  if (prize.toLowerCase().includes("monthly")) wins[winner].monthly++;

  document.getElementById("result").textContent =
    `Winner: ${winner}`;
  document.getElementById("details").textContent =
    `Prize: ${prize} | Total entries: ${total}`;

  saveState();
  renderLeaderboard();
}

function renderEntries() {
  entryTable.innerHTML = "";
  Object.entries(entries).forEach(([uid,count])=>{
    entryTable.innerHTML +=
      `<tr><td>${uid}</td><td>${count}</td></tr>`;
  });
}

function renderLeaderboard() {
  leaderboard.innerHTML = "";
  Object.entries(wins)
    .sort((a,b)=>
      b[1].beads - a[1].beads ||
      b[1].monthly - a[1].monthly
    )
    .forEach(([uid,data])=>{
      leaderboard.innerHTML +=
        `<tr>
          <td>${uid}</td>
          <td>${data.beads}</td>
          <td>${data.monthly}</td>
        </tr>`;
    });
}

function resetAll() {
  if (!confirm("Reset all entries and wins?")) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

loadState();
renderEntries();
renderLeaderboard();
</script>

</body>
</html>
